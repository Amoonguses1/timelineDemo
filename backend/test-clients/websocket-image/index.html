<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket 画像受信</title>
  </head>
  <body>
    <h2>WebSocket 画像受信テスト</h2>
    <input type="text" id="filename" placeholder="ファイル名を入力" />
    <button onclick="sendFileRequest()">画像リクエスト</button>
    <br /><br />
    <img id="imageDisplay" style="max-width: 500px; border: 1px solid black" />

    <script>
      const socket = new WebSocket('ws://localhost:80/api/getimg/ws');
      let receivedChunks = [];

      socket.binaryType = 'arraybuffer';

      socket.onopen = () => {
        console.log('WebSocket 接続成功！');
      };

      socket.onmessage = (event) => {
        if (event.data instanceof ArrayBuffer) {
          console.log('画像チャンクを受信しました');
          const chunk = new Uint8Array(event.data);
          receivedChunks.push(chunk); // チャンクを配列に追加

          // 受信した全てのチャンクを結合して画像を作成
          const totalSize = receivedChunks.reduce(
            (sum, chunk) => sum + chunk.length,
            0
          );
          const combined = new Uint8Array(totalSize);

          let offset = 0;
          for (let i = 0; i < receivedChunks.length; i++) {
            combined.set(receivedChunks[i], offset);
            offset += receivedChunks[i].length;
          }

          // Blob に変換して画像を表示
          const blob = new Blob([combined], { type: 'image/png' });
          const objectURL = URL.createObjectURL(blob);
          document.getElementById('imageDisplay').src = objectURL;
        } else {
          console.log('テキストメッセージ:', event.data);
        }
      };

      socket.onerror = (error) => {
        console.error('WebSocket エラー:', error);
      };

      socket.onclose = () => {
        console.log('WebSocket 接続が閉じられました');
      };

      function sendFileRequest() {
        const filename = document.getElementById('filename').value;
        if (!filename) {
          alert('ファイル名を入力してください！');
          return;
        }
        socket.send(filename); // ファイル名を WebSocket サーバーに送信
        console.log(`ファイルリクエスト送信: ${filename}`);
      }
    </script>
  </body>
</html>
